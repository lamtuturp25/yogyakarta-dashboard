<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
  <title>Peta NDVI per Bulan</title>

  <link rel="stylesheet" href="./resources/ol.css" />
  <link rel="stylesheet" href="./resources/fontawesome-all.min.css" />
  <link rel="stylesheet" href="./resources/ol-layerswitcher.css" />
  <link rel="stylesheet" href="./resources/qgis2web.css" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    #bulanNDVI {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .ol-popup {
      position: absolute;
      background-color: white;
      padding: 10px;
      border: 1px solid #ccc;
      bottom: 12px;
      left: -50px;
      min-width: 200px;
    }

    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 2px;
      right: 8px;
    }

    .ol-popup:after, .ol-popup:before {
      top: 100%;
      border: solid transparent;
      content: " ";
      height: 0;
      width: 0;
      position: absolute;
      pointer-events: none;
    }

    .ol-popup:after {
      border-top-color: white;
      border-width: 10px;
      left: 48px;
      margin-left: -10px;
    }

    .ol-popup:before {
      border-top-color: #ccc;
      border-width: 11px;
      left: 48px;
      margin-left: -11px;
    }
  </style>
</head>

<body>
  <!-- Dropdown Bulan -->
  <select id="bulanNDVI">
    <option value="NDVI_01_2024_2">Januari 2024</option>
    <option value="NDVI_02_2024_3">Februari 2024</option>
    <option value="NDVI_03_2024_4">Maret 2024</option>
  </select>

  <!-- Map & Popup -->
  <div id="map">
    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer">âœ–</a>
      <div id="popup-content"></div>
    </div>
  </div>

  <!-- Script Library -->
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="./resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/Autolinker.min.js"></script>
  <script src="./resources/qgis2web.js"></script>

  <!-- Layer & Style -->
  <script src="./layers/Administrasi_Kecamatan_1.js"></script>
  <script src="./layers/NDVI_01_2024_2.js"></script>
  <script src="./layers/NDVI_02_2024_3.js"></script>
  <script src="./layers/NDVI_03_2024_4.js"></script>
  <script src="./styles/Administrasi_Kecamatan_1_style.js"></script>
  <script src="./styles/NDVI_01_2024_2_style.js"></script>
  <script src="./styles/NDVI_02_2024_3_style.js"></script>
  <script src="./styles/NDVI_03_2024_4_style.js"></script>
  <script src="./layers/layers.js"></script>

  <!-- Logic Interaktif -->
  <script>
    window.onload = function () {
      const mapElement = document.getElementById("map");
      const popupContainer = document.getElementById("popup");
      const popupContent = document.getElementById("popup-content");
      const closer = document.getElementById("popup-closer");

      const overlay = new ol.Overlay({
        element: popupContainer,
        autoPan: true,
        autoPanAnimation: { duration: 250 }
      });

      map.addOverlay(overlay);

      closer.onclick = function () {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
      };

      // Ambil semua layer NDVI
      const ndviLayers = {
        "NDVI_01_2024_2": layersList.find(l => l.get("title") === "NDVI_01_2024_2"),
        "NDVI_02_2024_3": layersList.find(l => l.get("title") === "NDVI_02_2024_3"),
        "NDVI_03_2024_4": layersList.find(l => l.get("title") === "NDVI_03_2024_4")
      };

      // Tampilkan hanya layer Januari saat awal
      for (const key in ndviLayers) {
        ndviLayers[key].setVisible(key === "NDVI_01_2024_2");
      }

      const selectBulan = document.getElementById("bulanNDVI");

      selectBulan.addEventListener("change", function () {
        const selected = this.value;
        for (const key in ndviLayers) {
          ndviLayers[key].setVisible(key === selected);
        }
      });

      // Klik pada fitur untuk tampilkan popup
      map.on('singleclick', function (evt) {
        const selectedLayerId = selectBulan.value;
        const activeLayer = ndviLayers[selectedLayerId];

        let found = false;

        map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
          if (layer === activeLayer) {
            const props = feature.getProperties();
            popupContent.innerHTML = `
              <strong>NDVI ${selectedBulanLabel(selectedLayerId)}</strong><br>
              Mean: ${props._mean ?? 'n/a'}<br>
              Min: ${props._min ?? 'n/a'}<br>
              Max: ${props._max ?? 'n/a'}
            `;
            overlay.setPosition(evt.coordinate);
            found = true;
          }
        });

        if (!found) {
          overlay.setPosition(undefined);
        }
      });

      function selectedBulanLabel(key) {
        if (key === 'NDVI_01_2024_2') return 'Januari 2024';
        if (key === 'NDVI_02_2024_3') return 'Februari 2024';
        if (key === 'NDVI_03_2024_4') return 'Maret 2024';
        return '';
      }
    };
  </script>
</body>
</html>
