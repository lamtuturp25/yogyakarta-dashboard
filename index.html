<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, user-scalable=no, maximum-scale=1, width=device-width" />
  <title>Peta NDVI 2024</title>

  <!-- CSS -->
  <link rel="stylesheet" href="./resources/ol.css" />
  <link rel="stylesheet" href="./resources/ol-layerswitcher.css" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #bulanNDVI {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 14px;
      border: 1px solid #ccc;
    }

    .ol-popup {
      position: absolute;
      background-color: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 200px;
    }

    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 2px;
      right: 8px;
      color: #888;
    }

    .ndvi-legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      border: 1px solid #ccc;
      z-index: 1000;
    }

    .ndvi-legend div {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .ndvi-legend span {
      width: 20px;
      height: 12px;
      margin-right: 6px;
      display: inline-block;
    }
  </style>
</head>

<body>
  <!-- Dropdown Bulan -->
  <select id="bulanNDVI">
    <option value="NDVI_01_2024_2">Januari 2024</option>
    <option value="NDVI_02_2024_3">Februari 2024</option>
    <option value="NDVI_03_2024_4">Maret 2024</option>
  </select>

  <!-- Map -->
  <div id="map">
    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer">✖</a>
      <div id="popup-content"></div>
    </div>
  </div>

  <!-- Legend -->
  <div class="ndvi-legend">
    <strong>NDVI</strong>
    <div><span style="background:#d7191c;"></span> 0.0–0.2</div>
    <div><span style="background:#fdae61;"></span> 0.2–0.3</div>
    <div><span style="background:#ffffbf;"></span> 0.3–0.4</div>
    <div><span style="background:#a6d96a;"></span> 0.4–0.6</div>
    <div><span style="background:#1a9641;"></span> >0.6</div>
  </div>

  <!-- JS -->
  <script src="./resources/ol.js"></script>
  <script src="./resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="./resources/Autolinker.min.js"></script>

  <!-- Layer Files -->
  <script src="./layers/Administrasi_Kecamatan_1.js"></script>
  <script src="./layers/NDVI_01_2024_2.js"></script>
  <script src="./layers/NDVI_02_2024_3.js"></script>
  <script src="./layers/NDVI_03_2024_4.js"></script>
  <script src="./styles/Administrasi_Kecamatan_1_style.js"></script>
  <script src="./styles/NDVI_01_2024_2_style.js"></script>
  <script src="./styles/NDVI_02_2024_3_style.js"></script>
  <script src="./styles/NDVI_03_2024_4_style.js"></script>
  <script src="./layers/layers.js"></script>
  <script src="./resources/qgis2web.js"></script>

  <!-- Interaktif NDVI -->
  <script>
    window.onload = function () {
      // Google Basemaps
      const googleMaps = new ol.layer.Tile({
        title: 'Google Maps',
        type: 'base',
        visible: true,
        source: new ol.source.XYZ({
          url: 'https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}'
        })
      });

      const googleSatellite = new ol.layer.Tile({
        title: 'Google Satellite',
        type: 'base',
        visible: false,
        source: new ol.source.XYZ({
          url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'
        })
      });

      map.getLayers().insertAt(0, googleSatellite);
      map.getLayers().insertAt(0, googleMaps);

      // Layer Switcher
      const layerSwitcher = new ol.control.LayerSwitcher({
        tipLabel: 'Pilih Peta Dasar'
      });
      map.addControl(layerSwitcher);

      // Popup
      const overlay = new ol.Overlay({
        element: document.getElementById('popup'),
        autoPan: true,
        autoPanAnimation: { duration: 250 }
      });
      map.addOverlay(overlay);

      document.getElementById('popup-closer').onclick = function () {
        overlay.setPosition(undefined);
        return false;
      };

      // NDVI Layers
      const ndviLayers = {
        'NDVI_01_2024_2': layersList.find(l => l.get('title') === 'NDVI_01_2024_2'),
        'NDVI_02_2024_3': layersList.find(l => l.get('title') === 'NDVI_02_2024_3'),
        'NDVI_03_2024_4': layersList.find(l => l.get('title') === 'NDVI_03_2024_4'),
      };

      // Tampilkan default Januari
      for (const key in ndviLayers) {
        ndviLayers[key].setVisible(key === 'NDVI_01_2024_2');
      }

      // Dropdown ganti bulan
      document.getElementById('bulanNDVI').addEventListener('change', function () {
        const selected = this.value;
        for (const key in ndviLayers) {
          ndviLayers[key].setVisible(key === selected);
        }
      });

      // Klik fitur untuk popup
      map.on('singleclick', function (evt) {
        const selected = document.getElementById('bulanNDVI').value;
        const activeLayer = ndviLayers[selected];
        let found = false;

        map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
          if (layer === activeLayer) {
            const props = feature.getProperties();
            const html = `
              <strong>${props.nama_kecamatan || 'Wilayah'}</strong><br>
              Mean NDVI: ${props._mean?.toFixed(3) || 'n/a'}<br>
              Min NDVI: ${props._min?.toFixed(3) || 'n/a'}<br>
              Max NDVI: ${props._max?.toFixed(3) || 'n/a'}
            `;
            document.getElementById('popup-content').innerHTML = html;
            overlay.setPosition(evt.coordinate);
            found = true;
          }
        });

        if (!found) overlay.setPosition(undefined);
      });
    };
  </script>
</body>
</html>
